(my["webpackJsonp"]=my["webpackJsonp"]||[]).push([["pages/plus/chat/chat"],{"0ca0":function(t,e,i){},1990:function(t,e,i){"use strict";var n=i("0ca0"),o=i.n(n);o.a},"3cc6":function(t,e,i){"use strict";i.r(e);var n=i("b38f"),o=i.n(n);for(var s in n)["default"].indexOf(s)<0&&function(t){i.d(e,t,(function(){return n[t]}))}(s);e["default"]=o.a},"5a24":function(t,e,i){"use strict";i.r(e);var n=i("a2ef"),o=i.n(n);for(var s in n)["default"].indexOf(s)<0&&function(t){i.d(e,t,(function(){return n[t]}))}(s);e["default"]=o.a},"6fd1":function(t,e,i){"use strict";i.r(e);var n=i("7de8"),o=i("5a24");for(var s in o)["default"].indexOf(s)<0&&function(t){i.d(e,t,(function(){return o[t]}))}(s);var r=i("f0c5"),c=Object(r["a"])(o["default"],n["b"],n["c"],!1,null,null,null,!1,n["a"],void 0);e["default"]=c.exports},"7de8":function(t,e,i){"use strict";i.d(e,"b",(function(){return n})),i.d(e,"c",(function(){return o})),i.d(e,"a",(function(){}));var n=function(){var t=this.$createElement;this._self._c},o=[]},"7ecc":function(t,e,i){"use strict";i.r(e);var n=i("f87b"),o=i("3cc6");for(var s in o)["default"].indexOf(s)<0&&function(t){i.d(e,t,(function(){return o[t]}))}(s);i("1990");var r=i("f0c5"),c=Object(r["a"])(o["default"],n["b"],n["c"],!1,null,null,null,!1,n["a"],void 0);e["default"]=c.exports},a2ef:function(t,e,i){"use strict";(function(t){var n=i("4ea4");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o=n(i("7037")),s={data:function(){return{imageList:[]}},props:["num"],onLoad:function(){},mounted:function(){this.chooseImageFunc()},methods:{chooseImageFunc:function(){var e=this;t.chooseImage({count:e.num||9,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(t){e.uploadFile(t.tempFilePaths)},fail:function(t){e.$emit("getImgs",null)},complete:function(t){}})},uploadFile:function(e){var i=this,n=0,s=e.length,r={token:t.getStorageSync("token"),app_id:i.getAppId()};t.showLoading({title:"上传中"}),e.forEach((function(e,c){t.uploadFile({url:i.websiteUrl+"/index.php?s=/api/file.upload/image",filePath:e,name:"iFile",formData:r,success:function(t){var e="object"===(0,o.default)(t.data)?t.data:JSON.parse(t.data);1===e.code&&i.imageList.push(e.data)},complete:function(){n++,s===n&&(t.hideLoading(),i.$emit("getImgs",i.imageList))}})}))}}};e.default=s}).call(this,i("c11b")["default"])},b38f:function(t,e,i){"use strict";(function(t){var n=i("4ea4");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o=n(i("448a")),s=n(i("6fd1")),r={data:function(){return{my_user_id:"",you_user_id:"",myavatarUrl:"",avatarUrl:"",phoneHeight:0,scrollviewHigh:0,content:"",content_list:[],style:{pageHeight:0,contentViewHeight:0,footViewHeight:90,mitemHeight:0},isupload:!1,type:"license",scrollTop:0,img_path:"",is_product:!1,product_id:0,productDetail:{},socketTask:null,is_open_socket:!1,intervalId:null,page:1,nomore:!1,scrollHeight:0,nickName:"",url:"",status:"离线",is_live:!1,inputBottom:0,is_Ios:!0,order_chat:{},is_order:!1}},components:{Upload:s.default},created:function(){var e=t.getSystemInfoSync();this.style.pageHeight=e.windowHeight,this.style.contentViewHeight=e.windowHeight-t.getSystemInfoSync().screenWidth/750*100-70},onShow:function(){this.getAvatarUrl(),this.init(),this.isuserAgent()},onLoad:function(e){this.you_user_id=e.user_id,this.shop_supplier_id=e.shop_supplier_id,this.product_id=e.product_id?e.product_id:0,0!=this.product_id&&this.getProduct(),this.order_id=e.order_id?e.order_id:0,console.log(this.order_id),0!=this.order_id&&this.getOrder(),this.nickName=e.nickName,t.setNavigationBarTitle({title:this.nickName+"(离线)"}),this.get_content_list()},beforeDestroy:function(){console.log("beforeDestroy"),this.closeSocket(),this.is_live=!0},methods:{init:function(){var e=this;t.getSystemInfo({success:function(t){e.phoneHeight=t.windowHeight,e.scrollviewHigh=e.phoneHeight}})},initData:function(){this.page++,this.get_content_list()},socketInit:function(){var e=this;e.is_open_socket||(e.socketTask=null,e.socketTask=t.connectSocket({url:e.url+"/socket?user_id="+e.getUserId()+"&usertype=user&to="+e.you_user_id,success:function(){console.log("Socket连接成功！")}}),e.socketTask.onOpen((function(t){console.log("WebSocket连接正常打开中...！"),e.is_open_socket=!0,e.startHeart(),e.socketTask.onMessage((function(t){console.log("收到服务器内容："),console.log(t),e.getNewcontent(t)}))})),e.socketTask.onClose((function(){console.log("已经被关闭了"),e.socketTask=null,e.is_open_socket=!1,clearInterval(e.intervalId),!e.is_live&&e.socketInit()})))},send:function(t){this.is_open_socket?this.socketTask.send({data:t,success:function(){}}):(console.log("处于离线状态"),this.socketTask=null,this.is_open_socket=!1,clearInterval(this.intervalId),this.socketInit())},startHeart:function(){var t=this,e=JSON.stringify({type:"ping",app_id:t.getAppId(),supplier_user_id:t.you_user_id,user_id:t.my_user_id,shop_supplier_id:t.shop_supplier_id,msg_type:2});t.intervalId=setInterval((function(){console.log("发送心跳"),t.send(e)}),1e4)},closeSocket:function(){var t=JSON.stringify({type:"close",app_id:this.getAppId(),supplier_user_id:this.you_user_id,user_id:this.my_user_id,shop_supplier_id:this.shop_supplier_id,msg_type:2});this.send(t),this.socketTask.close({success:function(t){console.log("关闭成功",t)},fail:function(t){console.log("关闭失败",t)}}),this.socketTask=null,this.is_open_socket=!1,clearInterval(this.intervalId)},send_content:function(){if(""==this.content)return t.showToast({title:"发送内容不能为空！",icon:"none"}),!1;var e=JSON.stringify({supplier_user_id:this.you_user_id,user_id:this.my_user_id,shop_supplier_id:this.shop_supplier_id,msg_type:2,usertype:"user",type:0,content:this.content,app_id:this.getAppId()}),i=JSON.parse(e),n={msg_type:2,content:i.content,user_id:i.supplier_user_id,type:i.type,create_time:this.formatDate(),user:{avatarUrl:this.myavatarUrl}};this.content_list=[].concat((0,o.default)(this.content_list),[n]),this.$nextTick((function(){this.scrollToBottom()})),console.log(e),this.send(e),this.content=""},getNewcontent:function(e){var i=JSON.parse(e.data);if("off"!=i.Online||this.is_live||(this.status="离线",console.log("对方离线"),t.setNavigationBarTitle({title:this.nickName+"(离线)"})),"on"!=i.Online||this.is_live||(this.status="在线",console.log("对方在线"),t.setNavigationBarTitle({title:this.nickName+"(在线)"})),console.log(i),i.supplier_user_id==this.you_user_id&&i.content){var n={content:i.content,user_id:i.supplier_user_id,type:i.type,msg_type:1,user:{avatarUrl:this.avatarUrl}};console.log("解析数据"),this.content_list=[].concat((0,o.default)(this.content_list),[n]),this.$nextTick((function(){this.scrollToBottom()}))}if("init"==i.type){var s=this;s._post("plus.chat.chat/bindClient",{client_id:i.client_id,supplier_user_id:s.you_user_id},(function(e){"off"!=e.data.data.Online||s.is_live?"on"!=e.data.data.Online||s.is_live||(s.status="在线",console.log("对方在线"),t.setNavigationBarTitle({title:s.nickName+"(在线)"})):(s.status="离线",console.log("对方离线"),t.setNavigationBarTitle({title:s.nickName+"(离线)"})),console.log("init---绑定uid")}))}},getProduct:function(){var t=this;t._get("product.product/detail",{product_id:t.product_id,url:"",visitcode:t.getVisitcode()},(function(e){t.is_product=!0,t.content_list=[].concat((0,o.default)(t.content_list),[{type:4}]),t.productDetail=e.data.detail}))},getOrder:function(){var t=this;t._get("user.order/detail",{order_id:t.order_id},(function(e){t.is_order=!0,t.content_list=[].concat((0,o.default)(t.content_list),[{type:5}]),t.order_chat=e.data.order}))},upload:function(t){this.type=t,this.isupload=!0},getAvatarUrl:function(){var e=this;e.my_user_id=t.getStorageSync("user_id"),e._get("plus.chat.chat/getInfo",{user_id:e.my_user_id,shop_supplier_id:e.shop_supplier_id},(function(t){e.avatarUrl=t.data.info.logo,e.myavatarUrl=t.data.info.avatarUrl,e.url=t.data.info.url,e.$nextTick((function(){e.socketInit()}))}))},getImgsFunc:function(t){var e=this;if(null!=t&&t.length>0){this.img_path=t[0].file_path;var i=JSON.stringify({supplier_user_id:this.you_user_id,user_id:this.my_user_id,shop_supplier_id:this.shop_supplier_id,msg_type:2,usertype:"user",type:1,content:e.img_path,app_id:this.getAppId()}),n=JSON.parse(i),s={content:n.content,user_id:n.supplier_user_id,type:n.type,msg_type:2,create_time:e.formatDate(),user:{avatarUrl:e.myavatarUrl}};this.content_list=[].concat((0,o.default)(this.content_list),[s]),e.send(i),e.$nextTick((function(){e.scrollToBottom()}))}this.isupload=!1},get_content_list:function(){var e=this;t.showLoading({title:"加载中"}),e._post("plus.chat.chat/message",{page:e.page,supplier_user_id:e.you_user_id},(function(i){console.log(e.content_list);var n=i.data.list.data.reverse();e.content_list=[].concat((0,o.default)(n),(0,o.default)(e.content_list)),console.log(e.content_list),i.data.list.last_page<=e.page&&(e.nomore=!0),1==e.page?e.$nextTick((function(){e.scrollToBottom()})):e.$nextTick((function(){var i=t.createSelectorQuery().in(e);i.select(".im_interface_content").boundingClientRect((function(t){console.log(t),e.scrollTop=t.height-e.scrollHeight})).exec()})),t.hideLoading()}))},preview:function(e,i){var n=[],o=e;n.push(o);var s=1*i;t.previewImage({urls:n,current:s,indicator:"default"})},scrollToBottom:function(){var e=this,i=t.createSelectorQuery();i.selectAll(".m-item").boundingClientRect(),i.select("#scrollview").boundingClientRect(),i.exec((function(t){e.style.mitemHeight=0,t[0].forEach((function(t){return e.style.mitemHeight=e.style.mitemHeight+t.height+40})),setTimeout((function(){e.style.mitemHeight>e.style.contentViewHeight-100&&(e.scrollTop=e.style.mitemHeight-e.style.contentViewHeight+150)}),300)}))},sendProduct:function(){var t=this;t.is_product=!1;var e={product_name:t.productDetail.product_name,product_img:t.productDetail.product_image,product_price:t.productDetail.product_price};e=JSON.stringify(e);var i=JSON.stringify({supplier_user_id:this.you_user_id,user_id:this.my_user_id,shop_supplier_id:this.shop_supplier_id,msg_type:2,usertype:"user",content:e,type:2,app_id:this.getAppId()}),n=JSON.parse(i),s={content:n.content,user_id:n.supplier_user_id,create_time:t.formatDate(),type:n.type,msg_type:2,user:{avatarUrl:t.myavatarUrl}};this.content_list=[].concat((0,o.default)(this.content_list),[s]),t.send(i),t.$nextTick((function(){t.scrollToBottom()}))},sendOrder:function(){var t=this;t.is_product=!1;var e={order_num:t.order_chat.product.length,order_price:t.order_chat.order_price,order_no:t.order_chat.order_no,create_time:t.order_chat.create_time,order_id:t.order_chat.order_id,product_name:t.order_chat.product[0].product_name,product_img:t.order_chat.product[0].image.file_path};e=JSON.stringify(e);var i=JSON.stringify({supplier_user_id:this.you_user_id,user_id:this.my_user_id,shop_supplier_id:this.shop_supplier_id,msg_type:2,usertype:"user",content:e,type:3,app_id:this.getAppId()}),n=JSON.parse(i),s={content:n.content,user_id:n.supplier_user_id,create_time:t.formatDate(),type:n.type,msg_type:2,user:{avatarUrl:t.myavatarUrl}};this.content_list=[].concat((0,o.default)(this.content_list),[s]),t.send(i),t.$nextTick((function(){t.scrollToBottom()}))},getJSON:function(t){return JSON.parse(t)},newdata:function(){var e=this;this.page++;var i=t.createSelectorQuery().in(this);i.select(".im_interface_content").boundingClientRect((function(t){e.scrollHeight=t.height})).exec(),this.get_content_list()},inputFocus:function(t){this.inputBottom=t.detail.height},inputBlur:function(){this.inputBottom=0},isuserAgent:function(){switch(t.getSystemInfoSync().platform){case"android":this.is_Ios=!1,console.log("运行Android上");break;case"ios":console.log("运行iOS上");break;default:console.log("运行在开发者工具上");break}},formatDate:function(){var t=new Date,e=t.getFullYear(),i=t.getMonth()+1,n=t.getDate(),o=(t.getDay(),t.getHours());o=o<10?"0"+o:o;var s=t.getMinutes();s=s<10?"0"+s:s;var r=t.getSeconds();return r=r<10?"0"+r:r,"".concat(e,"-").concat(i,"-").concat(n," ").concat(o,":").concat(s,":").concat(r)}}};e.default=r}).call(this,i("c11b")["default"])},bda3:function(t,e,i){"use strict";(function(t){var e=i("4ea4");i("a8db"),i("33db"),i("5c17");e(i("66fd"));var n=e(i("7ecc"));my.__webpack_require_UNI_MP_PLUGIN__=i,t(n.default)}).call(this,i("c11b")["createPage"])},f87b:function(t,e,i){"use strict";i.d(e,"b",(function(){return n})),i.d(e,"c",(function(){return o})),i.d(e,"a",(function(){}));var n=function(){var t=this,e=t.$createElement,i=(t._self._c,t.__map(t.content_list,(function(e,i){var n=t.__get_orig(e),o=2==e.type?t.getJSON(e.content):null,s=2==e.type?t.getJSON(e.content):null,r=2==e.type?t.getJSON(e.content):null,c=3==e.type?t.getJSON(e.content):null,a=3==e.type?t.getJSON(e.content):null,u=3==e.type?t.getJSON(e.content):null,l=3==e.type?t.getJSON(e.content):null,d=3==e.type?t.getJSON(e.content):null,_=3==e.type?t.getJSON(e.content):null,p=3==e.type?t.getJSON(e.content):null;return{$orig:n,m0:o,m1:s,m2:r,m3:c,m4:a,m5:u,m6:l,m7:d,m8:_,m9:p}})));t._isMounted||(t.e0=function(e){t.is_product=!1},t.e1=function(e){t.is_order=!1}),t.$mp.data=Object.assign({},{$root:{l0:i}})},o=[]}},[["bda3","common/runtime","common/vendor"]]]);